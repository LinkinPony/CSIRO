# ğŸ”¬ DINOv3 Feature Statistics Visualizer

An interactive web-based visualization tool for analyzing DINOv3 backbone intermediate feature statistics. Built with Streamlit and Plotly for a modern, responsive experience.

![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)
![Streamlit](https://img.shields.io/badge/streamlit-1.28+-red.svg)
![Plotly](https://img.shields.io/badge/plotly-5.18+-purple.svg)

## âœ¨ Features

### ğŸ“ˆ Layer Analysis
- Cross-layer statistics visualization
- Trend analysis across all transformer blocks
- Heatmaps for layer-representation comparisons
- Single-layer deep dive with detailed breakdowns

### ğŸ” Channel Explorer
- Per-channel distribution histograms
- Mean vs Std scatter plots (colored by Max|x|)
- Correlation analysis between channel metrics
- Interactive data tables with sorting and filtering

### âš ï¸ Outlier Detection
- Z-score based outlier identification
- Cross-layer outlier heatmaps
- Persistent outlier tracking (channels abnormal across multiple layers)
- Configurable detection thresholds

### ğŸ“Š Comparison View
- Side-by-side representation comparisons (pre / per_layer_ln / global_ln)
- CLS vs Patch token overlays
- Cross-representation channel correlations
- Channel evolution tracking across layers

## ğŸš€ Quick Start

### 1. Install Dependencies

```bash
cd tools/feature_visualizer
pip install -r requirements.txt
```

### 2. Generate Feature Statistics

First, run the analysis script to generate the `.pt` file:

```bash
# From the project root
python analyze_dinov3_features.py \
    --project-dir . \
    --config configs/train.yaml \
    --max-images 0 \
    --device auto
```

This will create a file like `outputs/feature_stats/dinov3_feature_stats.pt`.

### 3. Launch the Visualizer

```bash
cd tools/feature_visualizer
streamlit run app.py
```

The app will open in your default browser at `http://localhost:8501`.

## ğŸ“ Project Structure

```
feature_visualizer/
â”œâ”€â”€ app.py                      # Main Streamlit application
â”œâ”€â”€ requirements.txt            # Python dependencies
â”œâ”€â”€ README.md                   # This file
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ data_loader.py          # Data loading and processing utilities
â””â”€â”€ pages/
    â”œâ”€â”€ 1_ğŸ“ˆ_Layer_Analysis.py   # Layer-wise statistics page
    â”œâ”€â”€ 2_ğŸ”_Channel_Explorer.py # Per-channel analysis page
    â”œâ”€â”€ 3_âš ï¸_Outlier_Detection.py # Outlier detection page
    â””â”€â”€ 4_ğŸ“Š_Comparison.py       # Comparison view page
```

## ğŸ“Š Data Format

The visualizer expects a `.pt` file generated by `analyze_dinov3_features.py` with the following structure:

```python
payload = {
    "meta": {
        "project_dir": str,
        "config": dict,
        "backbone": {
            "backbone_name": str,
            "dino_weights_pt": str,
            "used_lora": bool,
            ...
        },
        "counts": {
            "num_images": int,
            "num_batches": int,
            "num_layers": int,
            "embedding_dim": int,
            "n_storage_tokens": int,
        }
    },
    "layers": {
        layer_idx: {
            rep_name: {  # "pre", "per_layer_ln", "global_ln"
                role: {  # "cls", "patch"
                    "count": int,
                    "mean": Tensor[C],
                    "std": Tensor[C],
                    "max_abs": Tensor[C],
                }
            }
        }
    }
}
```

## ğŸ¨ Pages Overview

### Home (Overview)
- Model metadata and configuration
- Key statistics: images processed, layers, embedding dimension
- LoRA status and weight paths
- Data structure documentation

### Layer Analysis
- **Metric Selector**: Choose from mean_of_means, std_of_means, mean_of_stds, mean_max_abs, max_max_abs
- **Trend Plot**: Line chart showing how the metric evolves across layers
- **Heatmaps**: Visual comparison of representations at each layer
- **Deep Dive**: Detailed bar charts for any single layer

### Channel Explorer
- **Summary Cards**: Quick stats for the selected layer/rep/role
- **Histograms**: Distribution of mean, std, and max_abs across channels
- **Scatter Plot**: Mean vs Std relationship, colored by max_abs
- **Line Plot**: All channels' values in sequence
- **Top Channels**: Bar chart of channels sorted by selected metric

### Outlier Detection
- **Settings**: Configure metric, Z-score threshold, token role
- **Scatter Plot**: Visualize Z-scores with outlier highlighting
- **Cross-Layer Heatmap**: See where outliers concentrate
- **Persistent Outliers**: Identify channels abnormal in multiple layers

### Comparison
- **Representation Comparison**: Side-by-side histograms for pre/per_layer_ln/global_ln
- **Role Comparison**: Overlay of CLS vs Patch token distributions
- **Correlation Plots**: How channel values relate across normalizations
- **Layer Progression**: Track specific channels through all layers

## ğŸ”§ Configuration

### Default Data Path

The app automatically searches for feature stats in:
1. `../../outputs/feature_stats/dinov3_feature_stats.pt` (relative to app.py)
2. `../../outputs/train_all/feature_stats/dinov3_feature_stats.pt`

You can also:
- **Browse Directory**: Search any directory for `.pt` files
- **Manual Path**: Enter a custom file path directly

### Streamlit Config

Create `.streamlit/config.toml` for custom settings:

```toml
[theme]
primaryColor = "#6366f1"
backgroundColor = "#0f172a"
secondaryBackgroundColor = "#1e293b"
textColor = "#f1f5f9"
font = "sans serif"

[server]
port = 8501
headless = true
```

## ğŸ“ Usage Examples

### Analyze Last Layer Features

1. Navigate to **Channel Explorer**
2. Select Layer = 31 (or last layer)
3. Choose Representation = "Global LN"
4. Observe the Max|x| distribution for potential outliers

### Find Problematic Channels

1. Go to **Outlier Detection**
2. Set threshold = 3.0 (3 standard deviations)
3. Check "Persistent Outliers" for channels abnormal across layers
4. Cross-reference with **Channel Explorer** for details

### Compare Normalization Effects

1. Open **Comparison**
2. Select a deep layer (e.g., 28)
3. Compare Pre-norm vs Global LN histograms
4. Note the reduction in extreme values after normalization

## ğŸ¤ Contributing

Feel free to extend this visualizer with:
- Additional metrics or visualizations
- Export functionality (images, reports)
- Batch comparison of multiple runs
- Integration with training logs

## ğŸ“„ License

Part of the CSIRO Biomass project. See main repository for license details.

